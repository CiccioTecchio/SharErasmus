<html>


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Timeline</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="css/nprogress.css" rel="stylesheet">

    <!-- Custom Theme Style -->
    <link href="css/custom.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/style_Francesco.css">
    <link rel="stylesheet" type="text/css" href="css/fillable.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script>
        $(function () {
            $("#includedContent").load("top_bar.html");
        });
    </script>

    <style>
        table {
            margin-top: 10px;
            background-color: white;
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }

        td,
        th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even) {
            background-color: #dddddd;
        }
    </style>
</head>

<body onload="fill()">

    <div id="includedContent"></div>
    <div id="timeline" >
        <br>
        <!-- Smart Wizard -->
        <div id="wizard" class="form_wizard wizard_horizontal">
            <ul class="wizard_steps">
                <li>
                    <a href="#step-1">
                        <span class="step_no">1</span>
                        <span class="step_descr">
                            Step 1<br />
                            <small>Step 1 description</small>
                        </span>
                    </a>
                </li>
                <li>
                    <a href="#step-2">
                        <span class="step_no">2</span>
                        <span class="step_descr">
                            Step 2<br />
                            <small>Step 2 description</small>
                        </span>
                    </a>
                </li>
                <li>
                    <a href="#step-3">
                        <span class="step_no">3</span>
                        <span class="step_descr">
                            Step 3<br />
                            <small>Step 3 description</small>
                        </span>
                    </a>
                </li>
                <li>
                    <a href="#step-4">
                        <span class="step_no">4</span>
                        <span class="step_descr">
                            Step 4<br />
                            <small>Step 4 description</small>
                        </span>
                    </a>
                </li>
            </ul>

        </div>


    </div>

    <!-- Sidebar -->
    <div class="w3-sidebar w3-light-grey w3-bar-block" style="width:15%; position: relative">
        <h3 class="w3-bar-item"></h3>
        <div id="userinfo">
            <img name="out" src="" height="100" width="100" class="center">
            <p style="font-size:150%;" id="username_under_profile" class="center"></p>
        </div>

        <button style="font-size:150%;" class="w3-button w3-block w3-left-align" onclick="myAccFunc()">
            Informazioni <i class="fa fa-caret-down"></i>
        </button>
        <div id="demoAcc" class="w3-hide w3-white w3-card">
            <a id="matProfilo" style="font-size:130%;" class="w3-bar-item userinfo"><b>Matricola:</b><br></a>
            <a id="emailProfilo" style="font-size:130%;" class="w3-bar-item userinfo"><b>Email:</b><br></a>
            <a id="recapProfilo"  style="font-size:130%;" class="w3-bar-item userinfo"><b>Recapito:</b><br></a>
            <a id="statusProfilo"  style="font-size:130%;" class="w3-bar-item userinfo"><b>Status:</b><br></a>



        </div>
        <a href="#" style="font-size:150%;" class="w3-bar-item w3-button">Vai al profilo</a>
        <a href="#" style="font-size:150%;" class="w3-bar-item w3-button">Upload documento</a>
        <a href="#" style="font-size:150%;" class="w3-bar-item w3-button">Tabella ECTS</a>

    </div>

    <!-- Page Content -->
    <div style="margin-left:15%">

        <div class="w3-container hero-image">
            <div class="hero-text">
                <div>
                    <h2>Documenti:</h2>
                        <table id="documentTable">
                            <tr>
                                <th>Nome documento</th>
                                <th>Tipo</th>
                                <th>Data</th>
                                <th>Link</th>
                            </tr>
                        </table>
                </div>

                <br><br>
            </div>
            <!-- Nuova tabella -->
            <h2>Esami:</h2>
            <div>
                <div id="table" class="table-editable">

                    <table id="examTable" class="table">
                        <tr>
                            <th>Esame</th>
                            <th>Esame estero</th>
                            <th>Voto Esetero</th>
                            <th>Voto Italiano</th>
                            <th><button id="add-button" style="font-size: 100%;" onclick="addRow()" class="btn btn-primary">Aggiungi Esame</button></th>
                            

                        </tr>
                        <!-- This is our clonable table line -->
                        <tr class="hide">
                            <td id="ExamName" name="ExamName" class="cellname" contenteditable="true" value="prova"></td>
                            <td id="ExamNameEst" name="ExamNameEst" contenteditable="true"> </td>
                            <td id="ExamVoteEst" name="ExamVoteEst" contenteditable="true"> </td>
                            <td id="ExamVote" name="ExamVote" contenteditable="true"></td>
                            <td>
                                <span id="removeIcon"  class="table-remove glyphicon glyphicon-remove"></span>
                                <span id="saveIcon" hidden class="table-save glyphicon glyphicon-floppy-disk"></span>
                            </td>
                        </tr>
                    </table>
                </div>

                
                <p id="export"></p>
            </div>
        </div>





    </div>

</body>
<script>

    function myAccFunc() {
        var x = document.getElementById("demoAcc");
        if (x.className.indexOf("w3-show") == -1) {
            x.className += " w3-show";
            x.previousElementSibling.className += " selected";
        } else {
            x.className = x.className.replace(" w3-show", "");
            x.previousElementSibling.className =
                x.previousElementSibling.className.replace(" selected", "");
        }
    }

    //FUNZIONE UTILIZZATA PER OTTENERE LA DIMENSIONE DELL'ARRAY JSON
    function length(obj) {
        return Object.keys(obj).length;
    }

    function fill() {
        $.get("/coordinatore/userTimeline", function (data) {
            let userName = data[0].studente.nome + " " + data[0].studente.cognome;
            let email = data[0].studente.emailStudente;

            $("#username_under_profile").append(userName);
            $("#matProfilo").append(" " + data[0].studente.matricola);
            $("#emailProfilo").append(" " + email);
            $("#recapProfilo").append(" " + data[0].studente.recapito);
            $("#statusProfilo").append(" " + data[0].studente.status);


            let i = 0;
            var help3 = data[0].studente.imgProfilo;
            var output = document.getElementsByName("out");
            var reader = new FileReader();
            var blob = new Blob([new Uint8Array(help3.data)]);
            console.log(blob);
            reader.readAsDataURL(blob);
            reader.onload = (function (i, event) {
                base64data = event.target.result;
                output[i].src = base64data;
            }).bind(reader, i);
        });
        $.get("/coordinatore/userDocument", function (data) {
            for (i = 0; i < length(data); i++) {
                let nomeDoc = data[i].titolo;
                let tipDoc = data[i].tipo;
                let dataDoc = data[i].dataUpload;
                let linkDoc = "./stub.html";

                $("#documentTable").append(
                    "<tr>" +
                    "<td>" + nomeDoc + "</td>" +
                    "<td>" + tipDoc + "</td>" +
                    "<td>" + dataDoc + "</td>" +
                    "<td>" + "<a style=\"font-size: 100%;\" href=" + linkDoc + " \" " + "class=\"btn btn-primary\">" + "Visualizza" + "</a>" + "</td>" +
                    "</tr>"
                );
            }
        });
        $.get("/coordinatore/userVotes", function (data) {
            for (i = 0; i < length(data); i++) {
                let nomeEsame = data[i].nomeEsame;
                let voto = data[i].votoIta;
                let esameEstero = data[i].esameEstero;
                let votoEstero = data[i].votoEstero;
                $('#ExamName').text(nomeEsame);
                $('#ExamNameEst').text(esameEstero);
                $('#ExamVote').text(voto);
                $('#ExamVoteEst').text(votoEstero);
        

                var helpMe = $TABLE.find('tr.hide').clone(true);
                helpMe.removeClass('hide table-line');
                $TABLE.find('table').append(helpMe);


                $('#ExamName').text("");
                $('#ExamNameEst').text("");
                $('#ExamVote').text("");
                $('#ExamVoteEst').text("");


            }
        });
    }

    var $TABLE = $('#table');
    var $BTN = $('#export-btn');
    var $EXPORT = $('#export');

    function addRow(){
        var $clone = $TABLE.find('tr.hide').clone(true).removeClass('hide table-line');
        $clone.find("td:eq(4) > span")[1].removeAttribute("hidden");
        $clone.find("td:eq(4) > span")[0].setAttribute("hidden", "");
        $TABLE.find('table').append($clone);
    }

    $('.table-save').click(function () {
        let currentRow = $(this).closest("tr");
        let col1 = currentRow.find("td:eq(0)").text(); // get current row 1st TD value
        let col2 = currentRow.find("td:eq(1)").text(); // get current row 2nd TD
        let col3 = currentRow.find("td:eq(2)").text(); // get current row 3rd TD
        let col4 = currentRow.find("td:eq(3)").text(); // get current row 3rd TD
        let test = col1 + "\n" + col2 + "\n" + col3 + "\n" + col4;
        console.log("CONSOLE LOG:" + test); 
        if(col1 != "" && col2 != "" && col3 != "" && col4 != ""){
            currentRow.find("td:eq(4) > span")[0].removeAttribute("hidden");
            currentRow.find("td:eq(4) > span")[1].setAttribute("hidden", "");
            creaVoto(col1, col2, col3, col4);
        }else{
            alert("Tutti i campi devono essere rimepiti prima di salvare!");
        }

       
    });

    $('.table-remove').click(function () {
        let currentRow = $(this).closest("tr");
        let nome = currentRow.find("td:eq(0)").text(); // get current row 1st TD value
        let nomeE = currentRow.find("td:eq(1)").text(); // get current row 2nd TD
        let voto = currentRow.find("td:eq(2)").text(); // get current row 3rd TD
        let votoE = currentRow.find("td:eq(3)").text(); // get current row 3rd TD
        
        cancellaVoto(nome, nomeE, voto, votoE);
        $(this).parents('tr').detach();

    });

    $('.table-up').click(function () {
        var $row = $(this).parents('tr');
        if ($row.index() === 1) return; // Don't go above the header
        $row.prev().before($row.get(0));
    });

    $('.table-down').click(function () {
        var $row = $(this).parents('tr');
        $row.next().after($row.get(0));
    });

    // A few jQuery helpers for exporting only
    jQuery.fn.pop = [].pop;
    jQuery.fn.shift = [].shift;

    $BTN.click(function () {
        var $rows = $TABLE.find('tr:not(:hidden)');
        var headers = [];
        var data = [];

        // Get the headers (add special header logic here)
        $($rows.shift()).find('th:not(:empty)').each(function () {
            headers.push($(this).text().toLowerCase());
        });

        // Turn all existing rows into a loopable array
        $rows.each(function () {
            var $td = $(this).find('td');
            var h = {};

            // Use the headers from earlier to name our hash keys
            headers.forEach(function (header, i) {
                h[header] = $td.eq(i).text();
            });

            data.push(h);
        });

        // Output the result
        $EXPORT.text(JSON.stringify(data));
    });
    function creaVoto(nome, nomeE, voto, votoIta) {
        $.get('/coordinatore/createVote?nomeEsame=' + nome + "&votoIta=" + votoIta + "&esameEstero=" + nomeE + "&votoEstero=" + voto, function (data) {
            alert("Crea voto test");
        });
    }
    function cancellaVoto(nome, nomeE, voto, votoE) {
        $.get('/coordinatore/deleteVote?idTimeline=1' + "&nomeEsame=" + nome, function (data) {
        });
    }

</script>

</html>